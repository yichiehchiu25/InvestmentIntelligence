"""
Streamlit Example for Investment Research Platform Integration

This example demonstrates how to read and display the markdown summaries
generated by the investment research platform.

Requirements:
pip install streamlit pandas requests

Usage:
streamlit run streamlit_example.py
"""

import streamlit as st
import requests
import json
import os
from datetime import datetime, timedelta
import pandas as pd

# Configuration
API_BASE_URL = "http://localhost:5000/api"  # Update with your server URL
STORAGE_PATH = "./storage"  # Path to local storage directory

st.set_page_config(
    page_title="æŠ•è³‡ç ”ç©¶æ•¸æ“šåˆ†æ",
    page_icon="ğŸ“Š",
    layout="wide"
)

def load_local_summaries():
    """Load summaries directly from local storage"""
    summaries_path = os.path.join(STORAGE_PATH, "summaries")
    
    if not os.path.exists(summaries_path):
        return {}
    
    summaries = {}
    for date_folder in os.listdir(summaries_path):
        date_path = os.path.join(summaries_path, date_folder)
        if os.path.isdir(date_path):
            summaries[date_folder] = {}
            for file in os.listdir(date_path):
                if file.endswith('.md'):
                    category = file.replace('_', ' ').replace('.md', '')
                    file_path = os.path.join(date_path, file)
                    with open(file_path, 'r', encoding='utf-8') as f:
                        summaries[date_folder][category] = f.read()
    
    return summaries

def fetch_from_api(endpoint):
    """Fetch data from the API"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}")
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        st.error(f"APIè«‹æ±‚å¤±æ•—: {e}")
        return None

def main():
    st.title("ğŸ“Š æŠ•è³‡ç ”ç©¶æ•¸æ“šåˆ†æå¹³å°")
    st.markdown("### åŸºæ–¼æ¯æ—¥AIåˆ†ææ‘˜è¦çš„æ•¸æ“šæ¢ç´¢å·¥å…·")
    
    # Sidebar for navigation
    st.sidebar.title("å°èˆªé¸å–®")
    view_mode = st.sidebar.selectbox(
        "é¸æ“‡æ•¸æ“šä¾†æº",
        ["æœ¬åœ°æª”æ¡ˆ", "APIæ¥å£", "å„²å­˜ç®¡ç†"]
    )
    
    if view_mode == "æœ¬åœ°æª”æ¡ˆ":
        display_local_data()
    elif view_mode == "APIæ¥å£":
        display_api_data()
    else:
        display_storage_management()

def display_local_data():
    """Display data from local storage"""
    st.header("æœ¬åœ°å„²å­˜æ•¸æ“š")
    
    summaries = load_local_summaries()
    
    if not summaries:
        st.warning("æœªæ‰¾åˆ°æœ¬åœ°æ‘˜è¦æ•¸æ“šã€‚è«‹ç¢ºä¿å¹³å°å·²é‹è¡Œä¸¦ç”Ÿæˆäº†æ‘˜è¦ã€‚")
        return
    
    # Date selection
    available_dates = sorted(summaries.keys(), reverse=True)
    selected_date = st.selectbox("é¸æ“‡æ—¥æœŸ", available_dates)
    
    if selected_date and selected_date in summaries:
        st.subheader(f"ğŸ“… {selected_date} å¸‚å ´åˆ†ææ‘˜è¦")
        
        # Category tabs
        categories = list(summaries[selected_date].keys())
        if categories:
            tabs = st.tabs(categories)
            
            for tab, category in zip(tabs, categories):
                with tab:
                    content = summaries[selected_date][category]
                    st.markdown(content)
        else:
            st.info("è©²æ—¥æœŸç„¡å¯ç”¨æ‘˜è¦")
    
    # Summary statistics
    st.subheader("ğŸ“ˆ æ•¸æ“šçµ±è¨ˆ")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("ç¸½å¤©æ•¸", len(summaries))
    
    with col2:
        total_summaries = sum(len(day_data) for day_data in summaries.values())
        st.metric("ç¸½æ‘˜è¦æ•¸", total_summaries)
    
    with col3:
        if summaries:
            latest_date = max(summaries.keys())
            st.metric("æœ€æ–°æ•¸æ“š", latest_date)

def display_api_data():
    """Display data from API"""
    st.header("APIæ•¸æ“šæ¥å£")
    
    # Fetch available dates
    dates_data = fetch_from_api("/storage/summaries")
    
    if dates_data and "availableDates" in dates_data:
        available_dates = dates_data["availableDates"]
        
        if available_dates:
            selected_date = st.selectbox("é¸æ“‡æ—¥æœŸ", available_dates)
            
            if selected_date:
                # Fetch summaries for selected date
                summaries_data = fetch_from_api(f"/storage/summaries/{selected_date}")
                
                if summaries_data:
                    st.subheader(f"ğŸ“… {selected_date} APIæ•¸æ“š")
                    
                    for summary in summaries_data:
                        with st.expander(f"ğŸ“‹ {summary['category']}"):
                            st.markdown(summary['content'])
        else:
            st.info("APIæš«ç„¡å¯ç”¨æ•¸æ“š")
    else:
        st.error("ç„¡æ³•é€£æ¥åˆ°APIæˆ–ç²å–æ•¸æ“š")

def display_storage_management():
    """Display storage management options"""
    st.header("å„²å­˜ç®¡ç†")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("å°å‡ºStreamlitæ•¸æ“š")
        if st.button("å°å‡ºæ•¸æ“š"):
            try:
                response = requests.post(f"{API_BASE_URL}/storage/export-streamlit")
                if response.status_code == 200:
                    st.success("æ•¸æ“šå°å‡ºæˆåŠŸï¼")
                    data = response.json()
                    st.json(data)
                else:
                    st.error("å°å‡ºå¤±æ•—")
            except requests.exceptions.RequestException as e:
                st.error(f"å°å‡ºè«‹æ±‚å¤±æ•—: {e}")
    
    with col2:
        st.subheader("æ¸…ç†èˆŠæ•¸æ“š")
        days_to_keep = st.number_input("ä¿ç•™å¤©æ•¸", min_value=1, value=30)
        if st.button("æ¸…ç†æ•¸æ“š"):
            try:
                response = requests.post(
                    f"{API_BASE_URL}/storage/cleanup",
                    json={"daysToKeep": days_to_keep}
                )
                if response.status_code == 200:
                    st.success(f"å·²æ¸…ç†è¶…é{days_to_keep}å¤©çš„èˆŠæ•¸æ“š")
                else:
                    st.error("æ¸…ç†å¤±æ•—")
            except requests.exceptions.RequestException as e:
                st.error(f"æ¸…ç†è«‹æ±‚å¤±æ•—: {e}")
    
    # Display storage index
    st.subheader("å„²å­˜ç´¢å¼•")
    index_data = fetch_from_api("/storage/index")
    if index_data:
        st.json(index_data)

def create_analysis_dashboard():
    """Create analysis dashboard from summaries"""
    st.header("ğŸ“Š åˆ†æå„€è¡¨æ¿")
    
    summaries = load_local_summaries()
    
    if not summaries:
        st.warning("ç„¡æ•¸æ“šå¯ä¾›åˆ†æ")
        return
    
    # Convert to DataFrame for analysis
    data_rows = []
    for date, categories in summaries.items():
        for category, content in categories.items():
            data_rows.append({
                'date': date,
                'category': category,
                'content_length': len(content),
                'word_count': len(content.split())
            })
    
    df = pd.DataFrame(data_rows)
    
    # Display charts
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("å„é¡åˆ¥æ‘˜è¦æ•¸é‡")
        category_counts = df['category'].value_counts()
        st.bar_chart(category_counts)
    
    with col2:
        st.subheader("æ¯æ—¥æ‘˜è¦è¶¨å‹¢")
        daily_counts = df.groupby('date').size()
        st.line_chart(daily_counts)

if __name__ == "__main__":
    main()
    
    # Add analysis dashboard
    if st.sidebar.checkbox("é¡¯ç¤ºåˆ†æå„€è¡¨æ¿"):
        create_analysis_dashboard()
    
    # Footer
    st.markdown("---")
    st.markdown("ğŸ’¡ **ä½¿ç”¨èªªæ˜**: é€™å€‹å·¥å…·å¯ä»¥è®€å–æŠ•è³‡ç ”ç©¶å¹³å°ç”Ÿæˆçš„æ¯æ—¥æ‘˜è¦ï¼Œæ”¯æŒæœ¬åœ°æª”æ¡ˆå’ŒAPIå…©ç¨®æ•¸æ“šä¾†æºã€‚")
    st.markdown("ğŸ”§ **æŠ€è¡“æ”¯æŒ**: ç¢ºä¿æŠ•è³‡ç ”ç©¶å¹³å°æ­£åœ¨é‹è¡Œï¼Œä¸¦ä¸”å·²ç¶“ç”Ÿæˆäº†ä¸€äº›æ‘˜è¦æ•¸æ“šã€‚")